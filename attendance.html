<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PresensiKita Pro - Presensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900">
    <div id="app-container" class="flex min-h-screen bg-slate-50">
        <div id="sidebar-container"></div>

        <main class="flex-1 lg:ml-64 p-4 md:p-8 pb-24 lg:pb-8">
            <div id="content-container">
                <!-- Content injected by JS -->
                <div class="flex items-center justify-center min-h-[60vh]">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { requireAuth, logout } from './js/auth.js';
        import { renderSidebar } from './js/components.js';
        import { SHIFT_DEFINITIONS, ShiftType, DEFAULT_SETTINGS } from './js/data.js';

        const user = requireAuth();
        if (user) {
            document.getElementById('sidebar-container').innerHTML = renderSidebar(user, window.location.pathname);
            lucide.createIcons();

            // Mobile Menu Logic
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileOverlay = document.getElementById('mobile-sidebar-overlay');
            const closeMobileSidebar = document.getElementById('close-mobile-sidebar');
            const logoutBtn = document.getElementById('logout-btn');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileOverlay.classList.remove('hidden');
                });
            }
            if (closeMobileSidebar) {
                closeMobileSidebar.addEventListener('click', () => {
                    mobileOverlay.classList.add('hidden');
                });
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Attendance Logic
            let stream = null;
            let videoElement = null;
            let isInside = false;
            let distance = 0;
            let locationError = null;
            let cameraError = null;
            let loading = false;
            let successData = null;

            const userShift = (() => {
                const type = user.shiftGroup.includes('Shift') ? ShiftType.PAGI : ShiftType.REGULER;
                return SHIFT_DEFINITIONS.find(s => s.type === type);
            })();

            const calculateDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371e3;
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            const startCamera = async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    if (videoElement) {
                        videoElement.srcObject = stream;
                    }
                    cameraError = null;
                    render();
                } catch (err) {
                    cameraError = "Gagal mengakses kamera. Mohon berikan izin kamera pada browser Anda.";
                    render();
                }
            };

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            };

            const getLocation = () => {
                if (!navigator.geolocation) {
                    locationError = "Geolocation tidak didukung oleh perangkat Anda.";
                    render();
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, DEFAULT_SETTINGS.officeLat, DEFAULT_SETTINGS.officeLng);
                        distance = dist;
                        isInside = dist <= DEFAULT_SETTINGS.radiusMeters;
                        locationError = null;
                        render();
                    },
                    (err) => {
                        locationError = "Gagal mengambil koordinat. Pastikan GPS aktif dan izin lokasi diberikan.";
                        render();
                    }
                );
            };

            const handleAction = (type) => {
                if (!isInside) {
                    alert(`Sistem mengunci tombol. Anda berada ${Math.round(distance || 0)}m dari titik pusat (Radius Max: ${DEFAULT_SETTINGS.radiusMeters}m).`);
                    return;
                }

                loading = true;
                render();

                const now = new Date();
                let status = 'HADIR';
                let lateMin = 0;

                if (type === 'MASUK' && userShift) {
                    const [sh, sm] = userShift.startTime.split(':').map(Number);
                    const shiftStartTime = new Date();
                    shiftStartTime.setHours(sh, sm, 0);

                    if (now > shiftStartTime) {
                        status = 'TERLAMBAT';
                        lateMin = Math.floor((now.getTime() - shiftStartTime.getTime()) / 60000);
                    }
                }

                setTimeout(() => {
                    successData = {
                        type,
                        time: now.toLocaleTimeString('id-ID'),
                        status,
                        lateMin
                    };
                    loading = false;
                    stopCamera();
                    render();
                }, 2000);
            };

            const reset = () => {
                successData = null;
                startCamera();
                getLocation();
                render();
            }

            const render = () => {
                const container = document.getElementById('content-container');

                if (successData) {
                    container.innerHTML = `
                      <div className="min-h-[80vh] flex flex-col items-center justify-center p-6 mt-16 lg:mt-0 max-w-xl mx-auto">
                        <div class="relative mb-12 flex justify-center">
                          <div class="bg-emerald-100 p-8 rounded-full text-emerald-600 animate-bounce shadow-xl shadow-emerald-50">
                            <i data-lucide="check-circle-2" width="80" height="80"></i>
                          </div>
                          <div class="absolute -top-4 right-1/3 bg-white p-3 rounded-2xl shadow-lg animate-pulse">
                            <i data-lucide="sparkles" class="text-amber-400" width="24" height="24"></i>
                          </div>
                        </div>
                        
                        <div class="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl w-full text-center space-y-6 mx-auto max-w-xl">
                          <div>
                            <h2 class="text-3xl font-black text-slate-900 tracking-tight uppercase">Presensi ${successData.type} Berhasil!</h2>
                            <p class="text-slate-400 font-bold mt-2">Data Anda telah aman tersimpan di server.</p>
                          </div>

                          <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-6 rounded-[2rem]">
                               <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Waktu</p>
                               <p class="text-xl font-black text-indigo-600">${successData.time}</p>
                            </div>
                            <div class="p-6 rounded-[2rem] ${successData.status === 'TERLAMBAT' ? 'bg-rose-50' : 'bg-emerald-50'}">
                               <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Status</p>
                               <p class="text-xl font-black ${successData.status === 'TERLAMBAT' ? 'text-rose-600' : 'text-emerald-600'}">
                                 ${successData.status}
                               </p>
                            </div>
                          </div>

                          ${successData.lateMin > 0 ? `
                            <div class="p-4 bg-rose-50 border border-rose-100 rounded-2xl flex items-center gap-3 text-rose-700 justify-center">
                               <i data-lucide="alert-triangle" width="20" height="20"></i>
                               <p class="text-sm font-bold uppercase tracking-tight">Terlambat: ${successData.lateMin} Menit</p>
                            </div>
                          ` : ''}

                          <button 
                            id="reset-btn"
                            class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black shadow-xl hover:bg-slate-800 transition-all uppercase tracking-widest text-sm"
                          >
                            Selesai & Tutup
                          </button>
                        </div>
                      </div>
                    `;
                    document.getElementById('reset-btn').onclick = reset;
                    lucide.createIcons();
                    return;
                }

                const currentTimeStr = new Date().toLocaleTimeString('id-ID');

                container.innerHTML = `
                    <div class="max-w-2xl mx-auto space-y-8 mt-16 lg:mt-0 pb-12">
                      <div class="text-center">
                        <h2 class="text-4xl font-black text-slate-900 tracking-tight uppercase">Presensi Real-time</h2>
                        <div class="flex items-center justify-center gap-4 mt-2">
                           <p class="text-slate-500 font-bold">Jadwal: <span class="text-indigo-600 uppercase">${userShift?.name || 'TIDAK ADA'}</span></p>
                           <span class="text-slate-300">|</span>
                           <p id="clock-display" class="text-indigo-600 font-black font-mono">${currentTimeStr}</p>
                        </div>
                      </div>

                      <div class="relative group overflow-hidden rounded-[3rem] border-8 border-white shadow-2xl bg-slate-200 aspect-square md:aspect-video flex items-center justify-center transition-all hover:scale-[1.01]">
                        ${stream ? `
                            <video id="webcam" autoplay playsinline muted class="w-full h-full object-cover scale-x-[-1]"></video>
                        ` : `
                           <div class="flex flex-col items-center gap-3 text-slate-400">
                             <i data-lucide="refresh-cw" class="animate-spin text-indigo-400" width="48" height="48"></i>
                             <p class="font-black uppercase tracking-widest text-xs">Menunggu Akses Kamera...</p>
                           </div>
                        `}
                        
                        <!-- Scanning Overlay -->
                        <div class="absolute inset-0 pointer-events-none border-[30px] border-black/5"></div>
                        <div class="absolute top-0 left-0 w-20 h-20 border-t-4 border-l-4 border-indigo-500 rounded-tl-3xl m-6"></div>
                        <div class="absolute bottom-0 right-0 w-20 h-20 border-b-4 border-r-4 border-indigo-500 rounded-br-3xl m-6"></div>
                        
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-none">
                           <div class="w-48 h-48 border-2 border-white/50 rounded-full animate-[ping_2s_infinite]"></div>
                           <div class="absolute w-64 h-64 border border-indigo-400/30 rounded-full animate-pulse"></div>
                        </div>
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-6 rounded-[2rem] flex items-center gap-5 border shadow-sm transition-all ${isInside ? 'bg-emerald-50 border-emerald-100 shadow-emerald-50' : 'bg-rose-50 border-rose-100 shadow-rose-50'}">
                          <div class="p-4 rounded-2xl ${isInside ? 'bg-emerald-500' : 'bg-rose-500'} text-white shadow-lg">
                            <i data-lucide="map-pin" width="24" height="24"></i>
                          </div>
                          <div>
                            <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Pengecekan Lokasi</p>
                            <p class="text-lg font-black ${isInside ? 'text-emerald-700' : 'text-rose-700'}">
                              ${isInside ? 'Radius Aman' : 'Di Luar Radius'}
                            </p>
                            ${distance !== null ? `<p class="text-[10px] font-bold text-slate-500 uppercase">Jarak: ${Math.round(distance)}m</p>` : ''}
                          </div>
                        </div>

                        <div class="p-6 rounded-[2rem] flex items-center gap-5 bg-indigo-50 border border-indigo-100 shadow-sm shadow-indigo-50">
                          <div class="p-4 bg-indigo-500 rounded-2xl text-white shadow-lg">
                             <i data-lucide="camera" width="24" height="24"></i>
                          </div>
                          <div>
                            <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Validasi Selfie</p>
                            <p class="text-lg font-black text-indigo-700">${stream ? 'Kamera Aktif' : 'Menunggu...'}</p>
                            <p class="text-[10px] font-bold text-slate-500 uppercase">AI Face Tracking: ON</p>
                          </div>
                        </div>
                      </div>

                      ${(locationError || cameraError) ? `
                        <div class="p-5 bg-amber-50 border border-amber-200 rounded-3xl flex gap-4 text-amber-800 text-sm font-bold shadow-sm animate-in fade-in duration-500">
                          <i data-lucide="alert-triangle" width="24" height="24" class="shrink-0 text-amber-500"></i>
                          <p class="leading-relaxed">${locationError || cameraError}</p>
                        </div>
                      ` : ''}

                      <div class="grid grid-cols-2 gap-6 pb-20">
                        <button
                          id="btn-masuk"
                          ${(loading || !isInside || !stream) ? 'disabled' : ''}
                          class="py-6 rounded-3xl font-black transition-all flex items-center justify-center gap-3 text-lg tracking-tighter shadow-2xl transform active:scale-95 ${(loading || !isInside || !stream) ? 'bg-slate-100 text-slate-400 cursor-not-allowed grayscale' : 'bg-indigo-600 text-white shadow-indigo-200 hover:bg-indigo-700'}"
                        >
                          ${loading ? '<i data-lucide="refresh-cw" class="animate-spin" width="24" height="24"></i>' : '<i data-lucide="check-circle-2" width="24" height="24"></i>'}
                          ABSEN MASUK
                        </button>
                        <button
                          id="btn-pulang"
                          ${(loading || !isInside || !stream) ? 'disabled' : ''}
                          class="py-6 rounded-3xl font-black border-4 transition-all flex items-center justify-center gap-3 text-lg tracking-tighter transform active:scale-95 ${(loading || !isInside || !stream) ? 'border-slate-100 text-slate-300 cursor-not-allowed grayscale' : 'border-indigo-600 text-indigo-600 hover:bg-indigo-50'}"
                        >
                           ${loading ? '<i data-lucide="refresh-cw" class="animate-spin" width="24" height="24"></i>' : '<i data-lucide="clock" width="24" height="24"></i>'}
                           ABSEN PULANG
                        </button>
                      </div>
                    </div>
                `;

                // Re-attach elements
                videoElement = document.getElementById('webcam');
                if (videoElement && stream) videoElement.srcObject = stream;

                const btnMasuk = document.getElementById('btn-masuk');
                const btnPulang = document.getElementById('btn-pulang');
                if (btnMasuk) btnMasuk.onclick = () => handleAction('MASUK');
                if (btnPulang) btnPulang.onclick = () => handleAction('PULANG');

                lucide.createIcons();
            };

            // Init
            startCamera();
            getLocation();

            setInterval(() => {
                const clock = document.getElementById('clock-display');
                if (clock) clock.textContent = new Date().toLocaleTimeString('id-ID');
            }, 1000);
        }
    </script>
</body>

</html>